# This file generated by staff_codegen
# For more information please visit: http://code.google.com/p/staff/

INTERFACES := foo.h fooXsd.h fooCommon.h
TARGET ?= foo


PLATFORM ?= $(shell $(CXX) -dumpmachine)
SRCDIR = ./
OBJDIR = obj/
OUTDIR = out/


ifneq ($(DEBUG),)
  CXXFLAGS += -D_DEBUG -g -O0
  LDFLAGS += -g -O0
endif

ifneq ($(HOST_STAFF_HOME),)
  STAFF_CODEGEN ?= STAFF_HOME=$(HOST_STAFF_HOME) $(HOST_STAFF_HOME)/bin/staff_codegen
else
ifneq ($(STAFF_HOME),)
  STAFF_CODEGEN ?= $(STAFF_HOME)/bin/staff_codegen
else
  STAFF_CODEGEN ?= staff_codegen
endif
endif

ifneq ($(STAFF_HOME),)
  CXXFLAGS += -I$(STAFF_HOME)/include/
  LDFLAGS += -L$(STAFF_HOME)/lib
endif

LDFLAGS += -lstaffutils -lstaffcommon -lstaffclient

CODEGEN_INTERFACES := $(patsubst %.h,$(SRCDIR)%.h,$(INTERFACES))
CODEGEN_HEADERS := $(patsubst %.h,%Proxy.h,$(CODEGEN_INTERFACES))
CODEGEN_SOURCES := $(patsubst %.h,%Proxy.cpp,$(CODEGEN_INTERFACES))
CODEGEN_FILES := $(CODEGEN_HEADERS) $(CODEGEN_SOURCES)

NON_CODEGEN_SOURCES := $(filter-out $(CODEGEN_SOURCES),$(wildcard $(SRCDIR)*.cpp))
SOURCES := $(CODEGEN_SOURCES) $(NON_CODEGEN_SOURCES)
OBJECTS := $(patsubst $(SRCDIR)%.cpp,$(OBJDIR)%.o,$(SOURCES))

.NOTPARALLEL: $(CODEGEN_FILES)

# == make ===========================================
make: "$(OBJDIR)" "$(OUTDIR)" $(OUTDIR)$(TARGET)

all: make

# link
$(OUTDIR)$(TARGET): $(OBJECTS)
	$(CXX) $(OBJECTS) -o $(OUTDIR)$(TARGET) $(LDFLAGS)

# compile
$(OBJDIR)%.o: $(SRCDIR)%.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

$(NON_CODEGEN_SOURCES): $(CODEGEN_SOURCES)

$(SRCDIR)%Proxy.h $(SRCDIR)%Proxy.cpp:: $(SRCDIR)%.h
	$(STAFF_CODEGEN) -u -tclient -c$(SRCDIR) $(INTERFACES)

# == clean ==========================================
clean:
	rm -f $(OUTDIR)$(TARGET) $(OBJECTS) $(CODEGEN_FILES)
	test ! -d $(OBJDIR) || rmdir -p $(OBJDIR)
	test ! -d $(OUTDIR) || rmdir -p $(OUTDIR)

# == mkdir ==========================================
"%/":
	@[ -z "$@" -o -d "$@" ] || mkdir -p $@ && chmod g+w $@

test: run
# == run ============================================
run: $(OUTDIR)$(TARGET)
	$(OUTDIR)$(TARGET)
